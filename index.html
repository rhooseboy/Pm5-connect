<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concept2 PM5 Cockpit v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0b0f19;
            color: #e5e7eb;
        }
        
        .metric-card {
            background: #111827;
            border: 1px solid #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .lcd-text {
            color: #60a5fa;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }

        .val-text {
            color: #34d399;
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.3);
        }

        canvas {
            background: #111827;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white tracking-tighter">PM5<span class="text-blue-500">_LINK</span> <span class="text-xs text-purple-400 align-top">v5</span></h1>
            <p class="text-xs text-gray-400">Concept2 Bluetooth Interface</p>
        </div>
        <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded flex items-center gap-2 transition-all shadow-lg shadow-blue-900/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
            </svg>
            Connect
        </button>
    </header>

    <!-- Main Dashboard -->
    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Big Metric: Watts -->
        <div class="metric-card rounded-xl p-6 flex flex-col justify-between relative overflow-hidden">
            <span class="text-gray-400 text-sm uppercase tracking-wider">Power</span>
            <div class="flex items-baseline mt-2">
                <span id="watts" class="text-5xl font-bold text-white lcd-text">0</span>
                <span class="ml-2 text-xl text-gray-500">W</span>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-800">
                <div id="wattsBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Big Metric: SPM -->
        <div class="metric-card rounded-xl p-6 flex flex-col justify-between">
            <span class="text-gray-400 text-sm uppercase tracking-wider">Stroke Rate</span>
            <div class="flex items-baseline mt-2">
                <span id="spm" class="text-5xl font-bold text-white lcd-text">0</span>
                <span class="ml-2 text-xl text-gray-500">s/m</span>
            </div>
        </div>

        <!-- Big Metric: Pace -->
        <div class="metric-card rounded-xl p-6 flex flex-col justify-between">
            <span class="text-gray-400 text-sm uppercase tracking-wider">Split / 500m</span>
            <div class="flex items-baseline mt-2">
                <span id="pace" class="text-5xl font-bold text-white lcd-text">0:00</span>
            </div>
        </div>

        <!-- Big Metric: Distance -->
        <div class="metric-card rounded-xl p-6 flex flex-col justify-between">
            <span class="text-gray-400 text-sm uppercase tracking-wider">Distance</span>
            <div class="flex items-baseline mt-2">
                <span id="distance" class="text-5xl font-bold text-white lcd-text">0</span>
                <span class="ml-2 text-xl text-gray-500">m</span>
            </div>
        </div>
    </main>

    <!-- Biomechanics Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="metric-card rounded-xl p-4 flex flex-col">
            <span class="text-xs text-gray-500 uppercase tracking-widest">Drive Length</span>
            <div class="flex items-baseline mt-1">
                <span id="driveLength" class="text-3xl font-mono text-white val-text">--</span>
                <span class="ml-1 text-sm text-gray-500">m</span>
            </div>
        </div>
        <div class="metric-card rounded-xl p-4 flex flex-col">
            <span class="text-xs text-gray-500 uppercase tracking-widest">Drive Time</span>
            <div class="flex items-baseline mt-1">
                <span id="driveTime" class="text-3xl font-mono text-white val-text">--</span>
                <span class="ml-1 text-sm text-gray-500">s</span>
            </div>
        </div>
        <div class="metric-card rounded-xl p-4 flex flex-col">
            <span class="text-xs text-gray-500 uppercase tracking-widest">Peak Force</span>
            <div class="flex items-baseline mt-1">
                <span id="peakForce" class="text-3xl font-mono text-white val-text">--</span>
                <span class="ml-1 text-sm text-gray-500">N</span>
            </div>
        </div>
    </div>

    <!-- Graphs & Technicals -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
        
        <!-- Force Curve Chart -->
        <div class="lg:col-span-2 metric-card rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-300">Live Force Curve</h3>
                <div class="flex items-center gap-2">
                    <div id="strokeIndicator" class="w-3 h-3 rounded-full bg-gray-700"></div>
                    <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">UUID: 0x003D</span>
                </div>
            </div>
            <div class="h-64 w-full relative">
                <canvas id="forceChart"></canvas>
                <!-- Ghost overlay -->
                <div class="absolute inset-0 pointer-events-none flex items-end justify-center opacity-10">
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full pb-6 px-2">
                        <path d="M0,100 Q50,0 100,100" fill="none" stroke="white" stroke-width="2" stroke-dasharray="5,5"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Technical Stats & Log -->
        <div class="metric-card rounded-xl p-6 flex flex-col">
            <h3 class="text-lg font-semibold text-gray-300 mb-4">Device Status</h3>
            <div class="space-y-4 mb-4">
                <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                    <span class="text-gray-400">Drag Factor</span>
                    <span id="dragFactor" class="text-xl font-mono text-blue-400">--</span>
                </div>
                <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                    <span class="text-gray-400">Stroke Count</span>
                    <span id="strokeCount" class="text-xl font-mono text-purple-400">--</span>
                </div>
                <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                    <span class="text-gray-400">Heart Rate</span>
                    <span id="heartRate" class="text-xl font-mono text-red-400">--</span>
                </div>
                <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                    <span class="text-gray-400">Monitor Time</span>
                    <span id="elapsedTime" class="text-sm font-mono text-gray-500">00:00:00</span>
                </div>
            </div>
            
            <div class="flex-grow"></div>
            <div class="text-xs text-gray-500 mb-1">Debug Log:</div>
             <div id="statusLog" class="text-xs text-green-400 font-mono h-24 overflow-y-auto border border-gray-800 bg-gray-900 p-2 rounded">
                Ready to connect...
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const PM5_ROWING_SERVICE_UUID = 'ce060030-43e5-11e4-916c-0800200c9a66';
        
        // Characteristics
        const CHAR_GENERAL_STATUS = 'ce060031-43e5-11e4-916c-0800200c9a66'; 
        const CHAR_ADDITIONAL_STATUS_1 = 'ce060032-43e5-11e4-916c-0800200c9a66'; 
        const CHAR_STROKE_DATA = 'ce060035-43e5-11e4-916c-0800200c9a66'; // Biomechanics
        const CHAR_FORCE_CURVE = 'ce06003d-43e5-11e4-916c-0800200c9a66'; 
        
        let bluetoothDevice;
        let lastStrokeCount = -1;
        let forceCurvePoints = [];

        // --- CHART SETUP ---
        const ctx = document.getElementById('forceChart').getContext('2d');
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(96, 165, 250, 0.5)');
        gradient.addColorStop(1, 'rgba(96, 165, 250, 0.0)');

        const forceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 60}, (_, i) => i),
                datasets: [{
                    label: 'Force',
                    data: [],
                    borderColor: '#60a5fa',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    x: { display: false },
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#1f2937' },
                        ticks: { display: false } 
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- CONNECTION LOGIC ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            log('Searching for "PM5"...');
            try {
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'PM5' }],
                    optionalServices: [PM5_ROWING_SERVICE_UUID]
                });

                log('Device found! Connecting...');
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(PM5_ROWING_SERVICE_UUID);

                // 1. General Status
                const generalChar = await service.getCharacteristic(CHAR_GENERAL_STATUS);
                await generalChar.startNotifications();
                generalChar.addEventListener('characteristicvaluechanged', handleGeneralStatus);

                // 2. Additional Status
                const addChar1 = await service.getCharacteristic(CHAR_ADDITIONAL_STATUS_1);
                await addChar1.startNotifications();
                addChar1.addEventListener('characteristicvaluechanged', handleAdditionalStatus1);

                // 3. Stroke Data (Biomechanics)
                try {
                    const strokeChar = await service.getCharacteristic(CHAR_STROKE_DATA);
                    await strokeChar.startNotifications();
                    strokeChar.addEventListener('characteristicvaluechanged', handleStrokeData);
                    log('Subscribed to Biomechanics (0x0035)');
                } catch(e) { log('Biomechanics unavailable'); }

                // 4. Force Curve
                try {
                    const forceChar = await service.getCharacteristic(CHAR_FORCE_CURVE);
                    await forceChar.startNotifications();
                    forceChar.addEventListener('characteristicvaluechanged', handleForceCurve);
                    log('Subscribed to Force Curve (0x003D)');
                } catch(e) { log('Force Curve unavailable'); }

                document.getElementById('connectBtn').innerHTML = `<span class="text-green-400">‚óè</span> Connected`;
                document.getElementById('connectBtn').classList.add('bg-green-900', 'text-green-100', 'border-green-600');
                log('Ready to Row!');

            } catch (error) {
                log('Error: ' + error);
            }
        });

        // --- DATA HANDLERS ---
        
        // 0x0031: General Status + Drag Factor
        function handleGeneralStatus(event) {
            const value = event.target.value;
            // Layout: [Elapsed(3)] [Dist(3)] [Type(1)] [IntType(1)] [SPM(1)] [HR(1)] ... [Drag(1) @ 17?]
            
            const timeTotal = (value.getUint8(0) | (value.getUint8(1) << 8) | (value.getUint8(2) << 16)) * 0.01;
            updateTime(timeTotal);

            const distTotal = (value.getUint8(3) | (value.getUint8(4) << 8) | (value.getUint8(5) << 16)) * 0.1;
            document.getElementById('distance').innerText = Math.floor(distTotal);

            const spm = value.getUint8(8);
            document.getElementById('spm').innerText = spm;
            
            // Try to pull drag factor (often at the end of this packet)
            if(value.byteLength >= 17) { // Check if packet is long enough
                // Spec says Drag Factor is often around byte 17
                // Let's check byte 16 or 17 (0-indexed)
                // C2 Spec: Byte 12 is Workout State... Byte 17 is Drag Factor?
                // Actually it might vary. Let's peek at the last few bytes
                const possibleDrag = value.getUint8(value.byteLength - 2); // Guessing location
                if (possibleDrag > 50 && possibleDrag < 250) {
                    document.getElementById('dragFactor').innerText = possibleDrag;
                }
            }
        }

        // 0x0032: Additional Status
        function handleAdditionalStatus1(event) {
            const value = event.target.value;
            
            // WATTS (Bytes 3-4)
            const wLow = value.getUint8(3);
            const wHigh = value.getUint8(4);
            const wattsRaw = (wLow | (wHigh << 8));
            
            if(wattsRaw < 2000) {
                 document.getElementById('watts').innerText = wattsRaw;
                 document.getElementById('wattsBar').style.width = Math.min((wattsRaw/500)*100, 100) + '%';
                 if (wattsRaw > 0) {
                     const paceSecs = Math.pow(2.8 / wattsRaw, 1/3) * 500;
                     document.getElementById('pace').innerText = formatTime(paceSecs);
                 }
            }

            // Heart Rate (Byte 7)
            const hr = value.getUint8(7);
            if(hr > 0 && hr < 240 && hr !== 255) {
                document.getElementById('heartRate').innerText = hr;
            }
            
            // Stroke Count (Bytes 9-10?)
            // We'll trust the Stroke Data packet for this mostly, but keep graph reset trigger here just in case
            if(value.byteLength > 10) {
                const strokeCount = value.getUint8(9) | (value.getUint8(10) << 8);
                if(strokeCount > 0 && strokeCount < 50000) {
                    document.getElementById('strokeCount').innerText = strokeCount;
                    if (lastStrokeCount !== -1 && strokeCount > lastStrokeCount) resetGraph();
                    lastStrokeCount = strokeCount;
                }
            }
        }
        
        // 0x0035: STROKE DATA (Biomechanics)
        function handleStrokeData(event) {
            const value = event.target.value;
            // Standard C2 Stroke Data Layout (0.01 resolution typically):
            // Bytes 0-2: Elapsed Time? 
            // Actually usually:
            // Byte 3: Drive Length (0.01m)
            // Byte 4: Drive Time (0.01s)
            // Byte 9-10: Peak Force (0.1 lbs)
            
            // Let's try parsing based on standard offsets:
            if(value.byteLength >= 10) {
                // Drive Length (Byte 3 - uint8)
                const dl = value.getUint8(3);
                if(dl > 0) document.getElementById('driveLength').innerText = (dl * 0.01).toFixed(2);
                
                // Drive Time (Byte 4 - uint8)
                const dt = value.getUint8(4);
                if(dt > 0) document.getElementById('driveTime').innerText = (dt * 0.01).toFixed(2);
                
                // Peak Force (Bytes 9-10 - uint16 0.1 lbs)
                // Need to convert Lbs -> Newtons (1 lb = 4.448 N)
                const pfLow = value.getUint8(9);
                const pfHigh = value.getUint8(10);
                const pfLbs = (pfLow | (pfHigh << 8)) * 0.1;
                
                if(pfLbs > 0) {
                    const pfNewtons = pfLbs * 4.448;
                    document.getElementById('peakForce').innerText = Math.round(pfNewtons);
                }
            }
        }
        
        // 0x003D: Force Curve
        function handleForceCurve(event) {
            const value = event.target.value;
            for (let i = 0; i < value.byteLength; i += 2) {
                if (i + 1 < value.byteLength) {
                    const val = value.getUint16(i, true); 
                    forceCurvePoints.push(val);
                }
            }
            if(forceCurvePoints.length > 150) forceCurvePoints = []; // Safety cap
            forceChart.data.datasets[0].data = forceCurvePoints;
            forceChart.update();
        }

        // --- UTILS ---
        function resetGraph() {
            forceCurvePoints = [];
            forceChart.data.datasets[0].data = [];
            forceChart.update();
            const indicator = document.getElementById('strokeIndicator');
            indicator.classList.remove('bg-gray-700');
            indicator.classList.add('bg-green-500');
            setTimeout(() => {
                indicator.classList.add('bg-gray-700');
                indicator.classList.remove('bg-green-500');
            }, 200);
        }

        function updateTime(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            document.getElementById('elapsedTime').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2,'0')}`;
        }

        function log(msg) {
            const logDiv = document.getElementById('statusLog');
            logDiv.innerHTML = `> ${msg}<br>` + logDiv.innerHTML;
        }

        window.addEventListener('beforeunload', () => {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
        });
    </script>
</body>
</html>
